{% extends "base.html" %}

{% block title %}تقرير تحليل الصورة - {{ analysis.filename }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto" id="report-content">
    <!-- Header -->
    <div class="gradient-bg rounded-xl p-6 text-white shadow-lg mb-8">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold">تقرير تحليل الصورة الأمني</h1>
                <p class="opacity-90 mt-1">نتيجة الفحص الشامل للصورة والكشف عن التهديدات</p>
            </div>
            <div class="mt-4 md:mt-0 text-center">
                <div class="text-sm opacity-80">تاريخ التقرير</div>
                <div class="text-lg font-semibold">{{ analysis.upload_date.strftime('%Y-%m-%d %H:%M:%S') }}</div>
            </div>
        </div>
    </div>

    <!-- Sample Info -->
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
            <div>
                <h2 class="text-xl font-bold text-green-600 mb-2">معلومات الصورة</h2>
                <div class="flex items-center">
                    <span class="bg-gray-200 rounded-full p-2 mr-3">
                        <i class="fas fa-image text-gray-700"></i>
                    </span>
                    <div>
                        <h3 class="font-semibold text-lg">{{ analysis.filename }}</h3>
                        <p class="text-gray-600 text-sm">{{ analysis.file_size // 1024 }} KB | {{ analysis.file_hash[:12] }}...</p>
                    </div>
                </div>
            </div>

            <div class="mt-4 md:mt-0">
                <span class="px-4 py-2 rounded-full text-lg font-bold
                    {% if analysis.is_malicious %} bg-red-100 text-red-800
                    {% else %} bg-green-100 text-green-800 {% endif %}">
                    {{ analysis.prediction }}
                </span>
            </div>
        </div>
    </div>

    <!-- Results Summary -->
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 mb-8 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-200">ملخص النتائج</h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- Risk Score -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-4 border-t-4 
                {% if analysis.risk_score >= 70 %} border-red-500
                {% elif analysis.risk_score >= 40 %} border-yellow-500
                {% else %} border-green-500 {% endif %}">
                <h3 class="font-semibold text-white mb-2">درجة الخطورة</h3>
                <p class="text-3xl font-bold 
                    {% if analysis.risk_score >= 70 %} text-red-400
                    {% elif analysis.risk_score >= 40 %} text-yellow-400
                    {% else %} text-green-400 {% endif %}">
                    {{ analysis.risk_score }}%
                </p>
                <div class="mt-3">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full 
                            {% if analysis.risk_score >= 70 %} bg-red-500
                            {% elif analysis.risk_score >= 40 %} bg-yellow-500
                            {% else %} bg-green-500 {% endif %}"
                             style="width: {{ analysis.risk_score }}%"></div>
                    </div>
                </div>
            </div>

            <!-- VirusTotal Results -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-4 border-t-4 border-blue-500">
                <h3 class="font-semibold text-white mb-2">VirusTotal</h3>
                {% set vt_result = analysis.get_virustotal_result() %}
                {% if vt_result and not vt_result.error %}
                    <p class="text-3xl font-bold 
                        {% if vt_result.positives > 0 %} text-red-400
                        {% else %} text-green-400 {% endif %}">
                        {{ vt_result.positives }}/{{ vt_result.total }}
                    </p>
                    <p class="text-sm text-gray-300 mt-1">
                        {% if vt_result.positives > 0 %}
                            <span class="text-red-400">{{ vt_result.positives }} محرك اكتشف تهديدات</span>
                        {% else %}
                            <span class="text-green-400">لا توجد تهديدات</span>
                        {% endif %}
                    </p>
                {% else %}
                    <p class="text-lg text-gray-400">غير متوفر</p>
                    <p class="text-sm text-gray-500">لم يتم فحص الصورة</p>
                {% endif %}
            </div>

            <!-- Steganography -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-4 border-t-4 
                {% if analysis.steganography_detected %} border-red-500
                {% else %} border-green-500 {% endif %}">
                <h3 class="font-semibold text-white mb-2">إخفاء البيانات</h3>
                <p class="text-2xl font-bold 
                    {% if analysis.steganography_detected %} text-red-400
                    {% else %} text-green-400 {% endif %}">
                    {% if analysis.steganography_detected %}مكتشف{% else %}غير مكتشف{% endif %}
                </p>
                <p class="text-sm text-gray-300 mt-1">
                    {% set stego_indicators = analysis.get_threat_indicators() %}
                    {{ stego_indicators|length }} مؤشر
                </p>
            </div>

            <!-- File Integrity -->
            <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-4 border-t-4 
                {% if file_signatures and not file_signatures.is_valid %} border-red-500
                {% else %} border-green-500 {% endif %}">
                <h3 class="font-semibold text-white mb-2">سلامة الملف</h3>
                <p class="text-2xl font-bold 
                    {% if file_signatures and not file_signatures.is_valid %} text-red-400
                    {% else %} text-green-400 {% endif %}">
                    {% if file_signatures and file_signatures.is_valid %}سليم{% else %}مشبوه{% endif %}
                </p>
                <p class="text-sm text-gray-300 mt-1">
                    {% if file_signatures %}
                        {{ file_signatures.detected_format or 'غير معروف' }}
                    {% else %}
                        غير متوفر
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- VirusTotal Detailed Results -->
    {% set vt_result = analysis.get_virustotal_result() %}
    {% if vt_result and not vt_result.error %}
    <div class="bg-white/10 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-8 card-hover border border-blue-500">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">
            <i class="fas fa-shield-virus mr-2 text-blue-400"></i> نتائج VirusTotal
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-gray-900/50 rounded-lg p-4 text-center">
                <div class="text-3xl font-bold 
                    {% if vt_result.positives > 0 %} text-red-400
                    {% else %} text-green-400 {% endif %}">
                    {{ vt_result.positives }}
                </div>
                <div class="text-gray-300">محرك اكتشف تهديدات</div>
            </div>

            <div class="bg-gray-900/50 rounded-lg p-4 text-center">
                <div class="text-3xl font-bold text-blue-400">{{ vt_result.total }}</div>
                <div class="text-gray-300">إجمالي المحركات</div>
            </div>

            <div class="bg-gray-900/50 rounded-lg p-4 text-center">
                <div class="text-3xl font-bold 
                    {% if vt_result.total > 0 and (vt_result.positives / vt_result.total * 100) > 10 %} text-red-400
                    {% else %} text-yellow-400 {% endif %}">
                    {% if vt_result.total > 0 %}
                        {{ '%.1f'|format(vt_result.positives / vt_result.total * 100) }}%
                    {% else %}
                        0.0%
                    {% endif %}
                </div>
                <div class="text-gray-300">نسبة الاكتشاف</div>
            </div>
        </div>

        {% if vt_result.permalink %}
        <div class="text-center">
            <a href="{{ vt_result.permalink }}" target="_blank" 
               class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                <i class="fas fa-external-link-alt mr-2"></i>
                عرض التقرير الكامل على VirusTotal
            </a>
        </div>
        {% endif %}

        {% if vt_result.scans %}
        <div class="mt-6">
            <h4 class="font-semibold text-white mb-3">تفاصيل المسح:</h4>
            <div class="max-h-80 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-900">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300">المحرك</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300">الحالة</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-300">النتيجة</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        {% for engine, result in vt_result.scans.items() %}
                        <tr class="hover:bg-gray-700/50">
                            <td class="px-4 py-2 text-sm text-gray-300">{{ engine }}</td>
                            <td class="px-4 py-2">
                                <span class="px-2 py-1 text-xs rounded-full 
                                    {% if result.detected %} bg-red-500/30 text-red-300
                                    {% else %} bg-green-500/30 text-green-300 {% endif %}">
                                    {{ 'مكتشف' if result.detected else 'نظيف' }}
                                </span>
                            </td>
                            <td class="px-4 py-2 text-sm text-gray-400">
                                {{ result.result if result.detected else '-' }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Threat Indicators -->
    <div class="bg-white/10 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-8 card-hover border border-gray-700">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">
            <i class="fas fa-exclamation-triangle mr-2 text-yellow-400"></i> مؤشرات التهديد
        </h2>

        {% set threat_indicators = analysis.get_threat_indicators() %}
        {% if threat_indicators %}
        <div class="space-y-4">
            {% for indicator in threat_indicators %}
            <div class="flex items-start p-4 bg-red-900/20 rounded-lg border border-red-500/30">
                <div class="flex-shrink-0 mt-1">
                    <i class="fas fa-times-circle text-red-400 text-lg mr-3"></i>
                </div>
                <div class="flex-1">
                    <p class="text-red-300 font-medium">{{ indicator }}</p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
            <div class="inline-block p-4 bg-green-900/30 rounded-full mb-4">
                <i class="fas fa-check-circle text-green-400 text-4xl"></i>
            </div>
            <h3 class="text-xl font-bold text-green-400 mb-2">لا توجد مؤشرات تهديد</h3>
            <p class="text-gray-300">لم يتم اكتشاف أي مؤشرات تهديد في الصورة</p>
        </div>
        {% endif %}
    </div>

    <!-- Metadata Analysis -->
    <div class="bg-white/10 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-8 card-hover border border-gray-700">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">
            <i class="fas fa-info-circle mr-2 text-blue-400"></i> تحليل البيانات الوصفية
        </h2>

        {% if metadata and not metadata.error %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Basic Info -->
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="font-semibold text-white mb-3">معلومات أساسية</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">الصيغة:</span>
                        <span class="text-white font-medium">{{ metadata.format or 'غير معروف' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">النمط:</span>
                        <span class="text-white font-medium">{{ metadata.mode or 'غير معروف' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">الأبعاد:</span>
                        <span class="text-white font-medium">{{ metadata.size[0] }} × {{ metadata.size[1] }} بكسل</span>
                    </div>
                </div>
            </div>

            <!-- EXIF Data -->
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="font-semibold text-white mb-3">بيانات EXIF</h3>
                {% if metadata.exif %}
                <div class="max-h-48 overflow-y-auto">
                    <table class="min-w-full text-sm">
                        <tbody class="divide-y divide-gray-700">
                            {% for key, value in metadata.exif.items() %}
                            <tr class="hover:bg-gray-800/50">
                                <td class="px-2 py-1 text-gray-400 text-xs">{{ key }}</td>
                                <td class="px-2 py-1 text-gray-300 text-xs truncate max-w-xs" title="{{ value }}">
                                    {{ value|truncate(40) }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-400 text-center py-4">لا توجد بيانات EXIF</p>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="text-center py-8">
            <i class="fas fa-exclamation-circle text-gray-400 text-4xl mb-3"></i>
            <p class="text-gray-300">لا توجد بيانات وصفية متاحة</p>
        </div>
        {% endif %}
    </div>

    <!-- File Analysis -->
    <div class="bg-white/10 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-8 card-hover border border-gray-700">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">
            <i class="fas fa-file-alt mr-2 text-purple-400"></i> تحليل الملف
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- File Signatures -->
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="font-semibold text-white mb-3">توقيعات الملف</h3>
                {% if file_signatures and not file_signatures.error %}
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">الصيغة المكتشفة:</span>
                        <span class="text-white font-medium">{{ file_signatures.detected_format or 'غير معروف' }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">الحالة:</span>
                        <span class="font-medium {% if file_signatures.is_valid %}text-green-400{% else %}text-red-400{% endif %}">
                            {% if file_signatures.is_valid %}سليم{% else %}مشبوه{% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">حجم الملف:</span>
                        <span class="text-white font-medium">{{ file_signatures.file_size // 1024 }} KB</span>
                    </div>
                </div>
                {% else %}
                <p class="text-gray-400 text-center py-4">لا توجد معلومات عن توقيعات الملف</p>
                {% endif %}
            </div>

            <!-- Suspicious Patterns -->
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="font-semibold text-white mb-3">الأنماط المشبوهة</h3>
                {% set suspicious_patterns = json.loads(analysis.suspicious_patterns) if analysis.suspicious_patterns else [] %}
                {% if suspicious_patterns %}
                <div class="max-h-48 overflow-y-auto">
                    <ul class="list-disc list-inside space-y-2">
                        {% for pattern in suspicious_patterns %}
                        <li class="text-red-300 text-sm">{{ pattern }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-check-circle text-green-400 text-2xl mb-2"></i>
                    <p class="text-gray-300">لا توجد أنماط مشبوهة</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Steganography Details -->
        {% set stego_indicators = json.loads(analysis.hidden_content) if analysis.hidden_content else [] %}
        {% if stego_indicators %}
        <div class="mt-6 bg-gray-900/50 rounded-lg p-4 border border-red-500/30">
            <h3 class="font-semibold text-red-400 mb-3">
                <i class="fas fa-eye-slash mr-2"></i> تفاصيل إخفاء البيانات
            </h3>
            <div class="max-h-48 overflow-y-auto">
                <ul class="list-disc list-inside space-y-2">
                    {% for indicator in stego_indicators %}
                    <li class="text-red-300 text-sm">{{ indicator }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Technical Details -->
    <div class="bg-white/10 backdrop-blur-sm rounded-xl shadow-lg p-6 mb-8 card-hover border border-gray-700">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">
            <i class="fas fa-cogs mr-2 text-gray-400"></i> التفاصيل التقنية
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- File Hashes -->
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="font-semibold text-white mb-3">بصمات الملف</h3>
                <div class="space-y-2">
                    <div>
                        <div class="text-gray-400 text-sm">SHA-256:</div>
                        <div class="text-white text-xs font-mono truncate" title="{{ analysis.file_hash }}">
                            {{ analysis.file_hash }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Info -->
            <div class="bg-gray-900/50 rounded-lg p-4 border border-gray-700">
                <h3 class="font-semibold text-white mb-3">معلومات التحليل</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-400">معرف التحليل:</span>
                        <span class="text-white">#{{ analysis.id }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">المستخدم:</span>
                        <span class="text-white">{{ analysis.user.username }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">الوقت المستغرق:</span>
                        <span class="text-white">{{ analysis.upload_date.strftime('%H:%M:%S') }}</span>
                    </div>
                </div>
            </div>

            <!-- Security Recommendations -->
            <div class="bg-gray-900/50 rounded-lg p-4 border 
                {% if analysis.is_malicious %} border-red-500
                {% else %} border-green-500 {% endif %}">
                <h3 class="font-semibold text-white mb-3">التوصيات الأمنية</h3>
                <div class="space-y-2">
                    {% if analysis.is_malicious %}
                    <div class="flex items-start">
                        <i class="fas fa-times-circle text-red-400 mt-1 mr-2"></i>
                        <span class="text-red-300 text-sm">لا تستخدم هذه الصورة - تحتوي على تهديدات محتملة</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-shield-alt text-yellow-400 mt-1 mr-2"></i>
                        <span class="text-yellow-300 text-sm">احذف الصورة من نظامك فوراً</span>
                    </div>
                    {% else %}
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-400 mt-1 mr-2"></i>
                        <span class="text-green-300 text-sm">الصورة آمنة للاستخدام</span>
                    </div>
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-400 mt-1 mr-2"></i>
                        <span class="text-blue-300 text-sm">تابع تحديثات النظام الأمنية</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Report Actions -->
    <div class="bg-gray-800/50 backdrop-blur-sm rounded-2xl shadow-md p-6 border-t-4 border-red-500 card-hover">
        <h2 class="text-xl font-bold text-white mb-4 pb-2 border-b border-gray-600">خيارات التقرير</h2>

        <div class="flex flex-col sm:flex-row gap-4 justify-center">
            <a href="{{ url_for('generate_image_pdf', analysis_id=analysis.id) }}"
               class="px-6 py-3 bg-gradient-to-r from-green-600 to-teal-600 text-white font-medium rounded-lg hover:from-green-700 hover:to-teal-700 transition-all flex items-center justify-center">
                <i class="fas fa-file-pdf mr-2"></i> حفظ كـ PDF
            </a>

            <button id="share-report-btn"
                    class="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-700 text-white font-medium rounded-lg hover:from-purple-700 hover:to-indigo-800 transition-all flex items-center justify-center">
                <i class="fas fa-share-alt mr-2"></i> مشاركة التقرير
            </button>

            <form action="{{ url_for('delete_image_analysis', analysis_id=analysis.id) }}" method="POST" class="inline">
                <button type="submit" onclick="return confirm('هل أنت متأكد من حذف هذا التحليل؟')"
                   class="px-6 py-3 bg-gradient-to-r from-red-600 to-pink-700 text-white font-medium rounded-lg hover:from-red-700 hover:to-pink-800 transition-all flex items-center justify-center">
                    <i class="fas fa-trash mr-2"></i> حذف التحليل
                </button>
            </form>

            <a href="{{ url_for('image_analysis') }}"
               class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-medium rounded-lg hover:from-blue-700 hover:to-indigo-800 transition-all flex items-center justify-center">
                <i class="fas fa-redo mr-2"></i> تحليل صورة أخرى
            </a>
        </div>
    </div>
</div>

<script>
    // مشاركة التقرير
    document.getElementById('share-report-btn').addEventListener('click', function() {
        const expiryDays = 7;
        const analysisId = {{ analysis.id }};

        fetch(`/share_image_analysis/${analysisId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `expiry_days=${expiryDays}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // إنشاء عنصر نصي مخفي لنسخ الرابط
                const tempInput = document.createElement('input');
                tempInput.value = data.share_url;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);

                alert('تم نسخ رابط المشاركة: ' + data.share_url);
            } else {
                alert('حدث خطأ أثناء توليد الرابط: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ أثناء توليد الرابط');
        });
    });

    // طباعة التقرير
    function printReport() {
        const printContent = document.getElementById('report-content').innerHTML;
        const originalContent = document.body.innerHTML;
        
        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;
        location.reload();
    }

    // تصدير البيانات كـ JSON
    function exportAsJSON() {
        const reportData = {
            analysis_id: {{ analysis.id }},
            filename: "{{ analysis.filename }}",
            file_hash: "{{ analysis.file_hash }}",
            prediction: "{{ analysis.prediction }}",
            risk_score: {{ analysis.risk_score }},
            is_malicious: {{ analysis.is_malicious|lower }},
            upload_date: "{{ analysis.upload_date }}",
            threat_indicators: {{ analysis.get_threat_indicators()|tojson }},
            virustotal_result: {{ analysis.get_virustotal_result()|tojson }},
            metadata: {{ metadata|tojson }}
        };

        const dataStr = JSON.stringify(reportData, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = 'image_analysis_report_{{ analysis.id }}.json';
        link.click();
    }

    // إضافة أزرار إضافية للوحة التحكم
    document.addEventListener('DOMContentLoaded', function() {
        const actionButtons = `
            <div class="flex justify-center mt-4 space-x-4">
                <button onclick="printReport()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg flex items-center">
                    <i class="fas fa-print mr-2"></i> طباعة
                </button>
                <button onclick="exportAsJSON()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg flex items-center">
                    <i class="fas fa-download mr-2"></i> تصدير JSON
                </button>
            </div>
        `;
        
        const reportActions = document.querySelector('.bg-gray-800\\/50.rounded-2xl.shadow-md.p-6');
        if (reportActions) {
            reportActions.insertAdjacentHTML('beforeend', actionButtons);
        }
    });
</script>

<style>
    @media print {
        body * {
            visibility: hidden;
        }
        #report-content, #report-content * {
            visibility: visible;
        }
        #report-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        .card-hover {
            box-shadow: none !important;
            border: 1px solid #ddd !important;
        }
        .bg-gray-800\\/50 {
            background: white !important;
            color: black !important;
        }
        .text-white {
            color: black !important;
        }
        .text-gray-300 {
            color: #666 !important;
        }
        .gradient-bg {
            background: #f0f0f0 !important;
            color: black !important;
        }
    }

    /* تحسينات التصميم */
    .card-hover {
        transition: all 0.3s ease;
    }
    
    .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    /* تخصيص شريط التمرير */
    .overflow-y-auto::-webkit-scrollbar {
        width: 6px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-track {
        background: #374151;
        border-radius: 3px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-thumb {
        background: #6B7280;
        border-radius: 3px;
    }
    
    .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: #9CA3AF;
    }
</style>
{% endblock %}
